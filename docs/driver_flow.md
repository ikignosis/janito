# OpenAI Driver Content Flow in Janito

This document explains how content generated by the OpenAI driver in Janito moves from the model to the terminal, focusing on the `ContentPartFound` event. This flow is relevant for streaming and interactive use cases where incremental content appears in your CLI.

---

## Flow Overview

1. **Model Response Handling (Driver Layer)**
    - The main entry is `OpenAIModelDriver._handle_content_part` (in `janito/drivers/openai/driver.py`). When the OpenAI API returns content, this method is invoked.
    - The method publishes a `ContentPartFound` event with the content part as its payload.

2. **Event Data Structure**
    - `ContentPartFound` is an event defined in `janito/driver_events.py`. It contains the actual piece of content generated by the model.

3. **Agent Streaming Interface**
    - The agent (`LLMAgent`, found in `janito/llm/agent.py`) wraps the driver. When `.chat()` is called on the agent, it yields events (including `ContentPartFound`) produced by the driver's streaming generation logic (`stream_generate`).

4. **CLI Core Loop (Chat/Prompt Handler)**
    - In interactive (chat) mode, the CLI (`janito/cli/chat_mode/session.py`, within `ChatSession._chat_loop`) uses the `PromptHandler` to run the user's prompt. The prompt handler iterates over events yielded by the agent during the call.

5. **Event Reporting / Output**
    - The `RichTerminalReporter` (`janito/cli/rich_terminal_reporter.py`) is responsible for displaying content in the terminal. It listens for `ContentPartFound` events and, upon receiving one, prints the content (as Markdown) to the terminal.
    - Only `ContentPartFound` events are printed as main output during regular CLI operations, ensuring responsive, streamed output.

---

## Sequence Diagram (Summary)

```
User prompt (in CLI)
   ↓
PromptHandler.run_prompt → agent.chat() (yields events)
   ↓
OpenAI driver streams content → _handle_content_part → publishes ContentPartFound
   ↓
Agent/CLI loop picks up ContentPartFound
   ↓
RichTerminalReporter.on_ContentPartFound prints content to terminal
```

---

## Key Classes & Files

- **janito/drivers/openai/driver.py**: Implements the OpenAI driver and event publishing.
- **janito/driver_events.py**: Defines the `ContentPartFound` event.
- **janito/llm/agent.py**: The agent yields events from the driver.
- **janito/cli/prompt_core.py**: Handles prompt execution and event iteration.
- **janito/cli/rich_terminal_reporter.py**: Handles printing event content to the user.
- **janito/cli/chat_mode/session.py**: Interactive CLI chat session management.

---

## Notes

- This event-driven flow supports streaming and responsive output for OpenAI and compatible drivers.
- Tool/function calls from the model are handled as separate event types (`ToolCallStarted`, etc.), but the main content is always raised as `ContentPartFound`.
- The pipeline is similar for other providers/drivers but may vary in event ordering and structure.

---

For more information, see code comments in the affected files or reach out to the maintainers for architectural questions.
